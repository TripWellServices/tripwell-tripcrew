datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Trip Category Enum (multi-select optional)
enum TripCategory {
  FAMILY
  RELAXATION
  BEACH
  HOLIDAY
  ROMANTIC
  ADVENTURE
  EVENT
  CITY
  KIDS
  FOOD
}

// Trip status: PLANNED = brainstorm/board, CONFIRMED = building itinerary
enum TripStatus {
  PLANNED
  CONFIRMED
}

// Itinerary item status (board columns when trip is PLANNED)
enum ItineraryItemStatus {
  CONSIDERING
  CONFIRMED
  DROPPED
}

// Itinerary item type
enum ItineraryItemType {
  event
  concert
  dining
  attraction
  lodging
  city
  other
}

// Stuff-to-do catalogue entry type (OG CityStuffToDo buckets)
enum StuffToDoType {
  ATTRACTION
  RESTAURANT
  NEAT_THING
}

// TripWell Enterprises - Master Container (like GoFastCompany)
model TripWellEnterprise {
  id          String   @id @default(uuid())
  name        String   @default("TripWell Enterprises")
  address     String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  travelers  Traveler[]  @relation("EnterpriseTravelers")
  lodging    Lodging[]   @relation("EnterpriseLodging")
  dining     Dining[]    @relation("EnterpriseDining")
  attractions Attraction[] @relation("EnterpriseAttractions")
}

// City — first-class (like GoFast race/location; not a string)
model City {
  id      String  @id @default(uuid())
  name    String  // e.g. "Boston", "Venice Beach"
  state   String?
  country String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  destinations   Destination[]
  stuffToDoItems StuffToDoItem[]
  concerts       Concert[]

  @@unique([name, state, country])
  @@index([name])
  @@index([country])
}

model Traveler {
  id         String  @id @default(uuid())
  firebaseId String? @unique
  email      String? @unique
  firstName  String?
  lastName   String?
  photoURL   String? // Google profile picture URL (from Firebase)

  // Profile fields (from OG TripWell ProfileSetup)
  hometownCity     String?
  homeState        String?
  persona          String? // "Art", "Food", "History", "Adventure"
  planningStyle    String? // "Spontaneous", "Mix of spontaneous and planned", "Set a plan and stick to it!"
  dreamDestination String?

  tripWellEnterpriseId String? // Optional initially for migration, then required
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  tripWellEnterprise  TripWellEnterprise? @relation("EnterpriseTravelers", fields: [tripWellEnterpriseId], references: [id])
  tripCrewMemberships TripCrewMember[]    @relation("TravelerTripCrewMemberships")
  tripCrewRoles       TripCrewRole[]      @relation("TravelerTripCrewRoles")
  suggestedItineraryItems ItineraryItem[] @relation("ItineraryItemSuggestedBy")
}

model TripCrew {
  id       String  @id @default(uuid())
  name     String?
  handle   String? @unique  // GoFast-style: public slug for invite URL (e.g. "boston-crew")
  joinCode String  @unique  // legacy; invite primary = handle

  // Relations
  memberships TripCrewMember[] // Junction table for members
  roles       TripCrewRole[]   // Junction table for admin/manager roles
  trips       Trip[]           // Trips belong to TripCrew
  joinCodes   JoinCode[]      // JoinCode registry (authoritative source for code-based invites)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([joinCode])
  @@index([handle])
}

// JoinCode Registry - Authoritative source for TripCrew invites
model JoinCode {
  id         String    @id @default(uuid())
  code       String    @unique // Normalized, uppercase code
  tripCrewId String
  tripCrew   TripCrew  @relation(fields: [tripCrewId], references: [id], onDelete: Cascade)
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?
  isActive   Boolean   @default(true)

  @@index([code])
  @@index([tripCrewId])
  @@map("join_codes")
}

model Trip {
  id     String   @id @default(uuid())
  crewId String
  crew   TripCrew @relation(fields: [crewId], references: [id], onDelete: Cascade)

  tripName   String
  purpose    String // free text (required)
  categories TripCategory[] // multi-select enum array (optional)

  // Lean: status + suggestedStops; "where" = Destination(s)
  status          TripStatus @default(CONFIRMED)
  suggestedStops  String?   // scratchpad e.g. "DC, NYC, summer concerts"

  // Legacy: optional for backward compat; prefer Destination(s)
  city    String?
  state   String?
  country String?

  startDate DateTime
  endDate   DateTime

  // Computed fields — set via service on create/update
  daysTotal Int
  dateRange String
  season    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  destinations    Destination[]
  itineraryItems  ItineraryItem[]
  logistics       LogisticItem[]
  packItems       PackItem[]
  // Legacy artifact links (optional tripId on Lodging/Dining/Attraction)
  lodging         Lodging?    @relation("TripLodging")
  dining          Dining[]    @relation("TripDining")
  attractions     Attraction[] @relation("TripAttractions")

  @@index([crewId])
}

// Destination — bolts to City (first-class), not string; trip can have many
model Destination {
  id      String  @id @default(uuid())
  tripId  String
  cityId  String
  name    String? // e.g. "Virginia Beach leg", "NYC stop"
  state   String? // optional override
  country String? // optional override
  order   Int     @default(0) // for multi-city order

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trip           Trip            @relation(fields: [tripId], references: [id], onDelete: Cascade)
  city           City            @relation(fields: [cityId], references: [id], onDelete: Restrict)
  itineraryItems ItineraryItem[]

  @@index([tripId])
  @@index([cityId])
}

model Lodging {
  id                   String   @id @default(uuid())
  tripId               String?  @unique // legacy; prefer ItineraryItem.lodgingId
  tripWellEnterpriseId String?  // optional scope for reusable artifact
  title                String
  address              String?
  website              String?
  phone                String?
  googlePlaceId        String?
  imageUrl             String?
  rating               Float?
  lat                  Float?
  lng                  Float?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  trip            Trip?             @relation("TripLodging", fields: [tripId], references: [id], onDelete: Cascade)
  tripWellEnterprise TripWellEnterprise? @relation("EnterpriseLodging", fields: [tripWellEnterpriseId], references: [id], onDelete: SetNull)
  itineraryItems  ItineraryItem[]

  @@index([tripId])
  @@index([tripWellEnterpriseId])
}

model Dining {
  id                  String    @id @default(uuid())
  tripId              String?   // legacy; prefer ItineraryItem.diningId
  tripWellEnterpriseId String?
  title               String
  category            String?
  address             String?
  phone               String?
  website             String?
  googlePlaceId       String?   @unique
  imageUrl            String?
  rating              Float?
  lat                 Float?
  lng                 Float?
  distanceFromLodging Float?
  driveTimeMinutes    Int?
  itineraryDay        DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  trip                Trip?     @relation("TripDining", fields: [tripId], references: [id], onDelete: Cascade)
  tripWellEnterprise  TripWellEnterprise? @relation("EnterpriseDining", fields: [tripWellEnterpriseId], references: [id], onDelete: SetNull)
  itineraryItems     ItineraryItem[]

  @@index([tripId])
  @@index([tripWellEnterpriseId])
}

model Attraction {
  id                   String    @id @default(uuid())
  tripId               String?   // legacy; prefer ItineraryItem.attractionId or stuffToDoId
  tripWellEnterpriseId String?
  title                String
  category             String?
  address              String?
  phone                String?
  website              String?
  googlePlaceId        String?   @unique
  imageUrl             String?
  rating               Float?
  lat                  Float?
  lng                  Float?
  distanceFromLodging  Float?
  driveTimeMinutes     Int?
  itineraryDay         DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  trip                Trip?     @relation("TripAttractions", fields: [tripId], references: [id], onDelete: Cascade)
  tripWellEnterprise  TripWellEnterprise? @relation("EnterpriseAttractions", fields: [tripWellEnterpriseId], references: [id], onDelete: SetNull)
  itineraryItems      ItineraryItem[]

  @@index([tripId])
  @@index([tripWellEnterpriseId])
}

// Stuff-to-do catalogue — independent, keyed by city + season (bolt-on from itinerary)
model StuffToDoItem {
  id          String        @id @default(uuid())
  cityId      String
  season      String        // spring | summer | fall | winter | any
  type        StuffToDoType
  name        String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  city           City            @relation(fields: [cityId], references: [id], onDelete: Cascade)
  itineraryItems ItineraryItem[]

  @@index([cityId])
  @@index([cityId, season])
}

// Concert — first-class event (artist, venue, city, date); can bolt to itinerary
model Concert {
  id          String    @id @default(uuid())
  name        String    // e.g. "Noah Kahan"
  artist      String?
  venue       String?
  cityId      String?
  eventDate   DateTime?
  url         String?
  imageUrl    String?
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  city           City?           @relation(fields: [cityId], references: [id], onDelete: SetNull)
  itineraryItems ItineraryItem[]

  @@index([cityId])
  @@index([eventDate])
}

// ItineraryItem — the one universal thing; optional refs to artifacts + catalogue
model ItineraryItem {
  id             String              @id @default(uuid())
  tripId         String
  status         ItineraryItemStatus  @default(CONSIDERING)
  title          String              // e.g. "Visit Venice Beach" or "go to beach"
  dateText       String?             // "July 22nd"
  date           DateTime?           // when assigned
  day            String?             // e.g. "Day 1" or enum
  destinationId  String?
  lodgingId      String?
  diningId       String?
  attractionId   String?
  stuffToDoId    String?             // bolt-on to catalogue (first-class, not string)
  concertId      String?             // bolt-on to Concert (event)
  type           ItineraryItemType?  @default(other)
  location       String?
  venue          String?
  notes          String?
  suggestedById  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trip         Trip          @relation(fields: [tripId], references: [id], onDelete: Cascade)
  destination  Destination?  @relation(fields: [destinationId], references: [id], onDelete: SetNull)
  lodging      Lodging?      @relation(fields: [lodgingId], references: [id], onDelete: SetNull)
  dining       Dining?       @relation(fields: [diningId], references: [id], onDelete: SetNull)
  attraction   Attraction?   @relation(fields: [attractionId], references: [id], onDelete: SetNull)
  stuffToDo    StuffToDoItem? @relation(fields: [stuffToDoId], references: [id], onDelete: SetNull)
  concert      Concert?      @relation(fields: [concertId], references: [id], onDelete: SetNull)
  suggestedBy  Traveler?     @relation("ItineraryItemSuggestedBy", fields: [suggestedById], references: [id], onDelete: SetNull)

  @@index([tripId])
  @@index([destinationId])
  @@index([stuffToDoId])
  @@index([concertId])
}

model LogisticItem {
  id         String   @id @default(uuid())
  tripId     String
  title      String
  detail     String?
  isComplete Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  trip       Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
}

model PackItem {
  id        String   @id @default(uuid())
  tripId    String
  title     String
  isPacked  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
}

// TripCrew Membership - Junction table (matching GoFast RunCrewMembership pattern)
model TripCrewMember {
  id         String @id @default(uuid())
  tripCrewId String
  travelerId String // ATHLETE-FIRST: Foreign key to Traveler

  // Timestamps
  joinedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tripCrew TripCrew @relation(fields: [tripCrewId], references: [id], onDelete: Cascade)
  traveler Traveler @relation("TravelerTripCrewMemberships", fields: [travelerId], references: [id], onDelete: Cascade)

  @@unique([tripCrewId, travelerId]) // Prevent duplicate memberships
  @@index([tripCrewId])
  @@index([travelerId])
  @@map("trip_crew_members")
}

// TripCrew Roles - Junction table for admin/manager roles (matching GoFast RunCrewManager pattern)
model TripCrewRole {
  id         String @id @default(uuid())
  tripCrewId String
  travelerId String
  role       String // "admin" | "manager"

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Relations
  tripCrew TripCrew @relation(fields: [tripCrewId], references: [id], onDelete: Cascade)
  traveler Traveler @relation("TravelerTripCrewRoles", fields: [travelerId], references: [id], onDelete: Cascade)

  @@unique([tripCrewId, travelerId])
  @@index([tripCrewId])
  @@index([travelerId])
  @@map("trip_crew_roles")
}
